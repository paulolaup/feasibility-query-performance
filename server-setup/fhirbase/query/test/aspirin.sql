CREATE
OR REPLACE FUNCTION coding_table(resource_table_name text, coding_jsonpath text default '{code,coding}',
                                     ref_col_name text default '{subject,id}')
    RETURNS TABLE
            (
                id         text,
                subject_id text,
                system     text,
                code       text,
                display    text
            )
AS
$$
BEGIN
RETURN QUERY EXECUTE format(
            'SELECT t.id, t.resource #>> %L AS subject_id, coding.system, coding.code, coding.display ' ||
            'FROM "%I" t, jsonb_to_recordset(t.resource #> %L) AS coding(system text, code text, display text)',
            ref_col_name, resource_table_name, coding_jsonpath);
END;
$$
LANGUAGE plpgsql;
CREATE
OR REPLACE FUNCTION filtered_coding_table(resource_table_name text, system_url text,
                                              coding_jsonpath text default '{code,coding}',
                                              ref_col_name text default '{subject,id}')
    RETURNS TABLE
            (
                id         text,
                subject_id text,
                code       text,
                display    text
            )
AS
$$
BEGIN
RETURN QUERY EXECUTE format(
            'SELECT ct.id, ct.subject_id, ct.code, ct.display ' ||
            'FROM coding_table(%L, %L, %L) ct WHERE ct.system = %L',
            resource_table_name, coding_jsonpath, ref_col_name, system_url);
END;
$$
LANGUAGE plpgsql;
WITH medicationadministration_coding_table AS (SELECT *
                                               FROM filtered_coding_table('medicationadministration',
                                                                          'http://www.nlm.nih.gov/research/umls/rxnorm',
                                                                          '{medication,CodeableConcept,coding}'))
SELECT *
FROM patient p
         JOIN medicationadministration_coding_table mact ON mact.subject_id = p.id
WHERE (mact.code IN
       ('2047428', '1730187', '2047427', '2565492', '2664074', '904664', '904668', '1006995', '1007005', '1007112',
        '1007240', '1007337', '1007353', '1007407', '1007424', '1007472', '1007613', '1008006', '1008080', '1008684',
        '1008791', '1008832', '1008877', '1008988', '1009038', '1053102', '1053120', '1111420', '135095', '1534422',
        '1593109', '1811630', '214160', '214249', '214250', '214251', '214253', '214254', '214255', '214256', '214257',
        '214258', '214259', '215451', '226716', '2394058', '282422', '392499', '466424', '466549', '466584', '669119',
        '687078', '689502', '689507', '689509', '689511', '689512', '689513', '689515', '689516', '689518', '689519',
        '689522', '689524', '689529', '689540', '689541', '689551', '689552', '689553', '689554', '689555', '689556',
        '690996', '690997', '812525', '813961', '814664', '815052', '816174', '816812', '816818', '817275', '817405',
        '817455', '817778', '817958', '818496', '819659', '819817', '820701', '1001476', '1052416', '1052678',
        '1053327', '1101754', '1189781', '1247397', '1247402', '1250909', '1293665', '1303159', '1304215', '1358853',
        '1361402', '1362082', '1536680', '1536835', '1537012', '1593116', '1600991', '1665362', '1722695', '1811916',
        '1811918', '1872088', '1925790', '1944113', '209468', '209823', '210864', '211292', '211297', '211310',
        '211832', '211874', '211881', '211887', '211891', '212086', '2563428', '2563431', '260847', '387090', '608696',
        '702320', '723530', '723533', '724444', '749795', '794229', '825180', '848166', '848928', '853501', '994239',
        '994277', '994530', '994537', '994539', '1001474', '1052414', '1053325', '1101753', '1189780', '1247394',
        '1247399', '1250908', '1293661', '1297835', '1303155', '1358849', '1361398', '1536678', '1536834', '1537010',
        '1593112', '1600987', '1665358', '1722691', '1811912', '1811917', '1925789', '1944109', '2563424', '2563430',
        '570079', '570399', '571342', '571734', '571739', '571752', '572163', '572203', '572210', '572216', '572220',
        '572393', '574308', '574548', '608695', '702318', '723528', '723531', '724442', '794228', '847089', '848165',
        '848927', '853500', '994238', '994276', '994529', '994536', '994538', '103863', '103954', '104474', '104475',
        '104899', '106809', '1092398', '1234872', '1250907', '1291868', '1433630', '1536467', '1536498', '1536503',
        '1536675', '1536815', '1536833', '1536840', '1536993', '1537019', '1537029', '1593110', '1665356', '1722689',
        '1811631', '1811632', '1872085', '197447', '197930', '197945', '198461', '198463', '198464', '198466', '198467',
        '198471', '198473', '198475', '198477', '198479', '198480', '199281', '205251', '212033', '2267026', '2360605',
        '238134', '238135', '2393784', '2394061', '243670', '243685', '243694', '246461', '247137', '252857', '2565491',
        '2583731', '259081', '2606079', '2626726', '2668107', '308278', '308297', '308363', '308403', '308409',
        '308411', '308416', '308417', '318272', '333834', '349516', '359221', '391930', '432638', '433353', '605252',
        '637540', '685589', '688214', '692836', '702316', '724614', '763111', '763116', '797050', '806446', '827318',
        '828585', '828594', '848768', '853499', '857121', '863184', '863186', '891134', '891136', '892160', '896884',
        '900470', '900528', '994226', '994237', '994430', '994435', '994528', '994535', '994810', '994811', '996988',
        '996991', '996994', '1665355', '2393781', '2394057', '315413', '315414', '315418', '315420', '315422', '315424',
        '315425', '315426', '315428', '315429', '315430', '315431', '315432', '315433', '317297', '317298', '317299',
        '317300', '329292', '329294', '329295', '329547', '332336', '335933', '335953', '335990', '335993', '336010',
        '336012', '336028', '336430', '350459', '350460', '647977', '685588', '688213', '863185', '891133', '891135',
        '892159', '900469', '994429', '994434'))
;
