SELECT COUNT(DISTINCT (inclusion.id))
FROM ((SELECT p.id FROM patient p WHERE (p.resource ->> 'birthDate')::timestamp <@ '(1957-10-01,2005-10-01)'::tsrange)
      INTERSECT
      (SELECT p.resource #>> '{subject,id}'
       FROM procedure p,
            jsonb_array_elements(p.resource #> '{code,coding}') coding
       WHERE coding ->> 'system' = 'http://snomed.info/sct'
         AND (coding ->> 'code' IN ('18831004', '699253003'))
         AND (p.resource #>> '{performed,Period,start}')::timestamp <@ '(2022-10-01,2023-10-01)'::tsrange
         AND (p.resource #>> '{performed,Period,end}')::timestamp < '2023-10-01'::timestamp)) inclusion
WHERE inclusion.id NOT IN ((SELECT c.resource #>> '{subject,id}'
                            FROM condition c,
                                 jsonb_array_elements(c.resource #> '{code,coding}') coding
                            WHERE coding ->> 'system' = 'http://snomed.info/sct'
                              AND (((coding ->> 'code' IN
                                     ('425879009', '274945004', '1085131000119105', '1085231000119100',
                                      '1085901000119101', '1085751000119100', '1085801000119106', '1085851000119105',
                                      '1092841000119100', '402427003', '402428008', '75053002', '969688801000119108',
                                      '236503001', '128600008', '966011731000119103', '453720571000119100', '239920006',
                                      '783160006', '397008008', '716655008', '1231149005', '1228881003', '367528006',
                                      '398229007', '1217476001', '735173007', '213320003', '79337003', '39579001',
                                      '871930001', '139841000119108', '15919571000119107', '871926004', '735447008',
                                      '762455001', '719040004', '427833000', '715887004', '716374005', '241930003',
                                      '427903006', '429751004', '1003758002', '430980000', '402390008', '735448003',
                                      '441492003', '442052005', '441495001', '428795003', '1187124004', '8161000119106',
                                      '241931004', '1144919009', '1144914004', '239922003', '239921005', '310701003',
                                      '57484009', '53485006', '54034003', '21542005', '3275009', '1197742004',
                                      '403443000', '58144006', '15673361000119100', '15673521000119101', '871554001',
                                      '1187540008', '231971006', '231970007', '1187538003', '787442004', '441971007',
                                      '444546002', '15342002', '13470001', '442159003', '52506002', '405810005',
                                      '1197732001', '1197428008', '241936009', '31848007', '721702009', '733157003',
                                      '515623061000119105', '527788091000119106', '253855721000119107', '737195007',
                                      '34000006', '426549001', '50440006', '56287005', '235607002', '722850002',
                                      '234999001', '38106008', '397173003', '91390005', '7620006', '196578009',
                                      '1197727002', '402376005', '70622003', '61424003', '3815005', '402377001',
                                      '399946006', '71833008', '56689002', '10743231000119101', '235664007',
                                      '196977009', '402375009', '62382002', '236505008', '190815001', '402431009',
                                      '402434001', '239926000', '710027002', '1230290005', '724783000', '10713006',
                                      '1144925008', '300161000119106', '1144809002', '241937000', '241935008',
                                      '82275008', '24829000', '239947001', '414153008', '414154002', '414156000',
                                      '241952007', '52661003', '726101009', '42295001', '402460000', '9133005',
                                      '41590007', '4463009', '5134006', '1162362005', '1162364006', '57160007',
                                      '73305009', '236539007', '91941002', '1144980001', '397172008', '89681000119101',
                                      '50581000', '195353004', '235000001', '232460001', '232369001', '1231671001',
                                      '239936008', '236504007', '1187119002', '402459005', '1197494003', '402395003',
                                      '241954008', '1173999006', '1197733006', '1230414002', '70910003', '1186721005',
                                      '238867003', '24526004', '721686000', '241939002', '737184001', '788718000',
                                      '410485009', '410484008', '1231735008', '1149218009', '201805000', '201807008',
                                      '239809007', '238861002', '195363007', '1217370006', '445243001', '55006001',
                                      '127911000119105', '127901000119107', '239935007', '299276009', '14654002',
                                      '196137000', '196133001', '403511003', '403510002', '239944008', '236511006',
                                      '236508005', '722086002', '307591004', '231972004', '110002002', '404172001',
                                      '402378006', '1144805008', '78324009', '78712000', '1119306006', '895448002',
                                      '32278006', '64741003', '402662002', '35001004', '241949004', '241947002',
                                      '698300001', '241945005', '241948007', '1155989002', '1155990006', '241944009',
                                      '241951000', '236540009', '700049004', '139201000119107', '402712002',
                                      '241933001', '724603009', '241938005', '235796008', '87442008', '239931003',
                                      '20258000', '155441006', '239927009', '239925001', '444819004', '1268344005',
                                      '195299000', '1217248006', '1217249003', '239924002', '407529009', '407530004',
                                      '733422008', '444133002', '72275000', '232439007', '236498004', '236507000',
                                      '236502006', '715401008', '38877003', '399923009', '402433007', '398640008',
                                      '1162677006', '28880005', '77522006', '54867000', '398726004', '239943002',
                                      '402432002', '201789001', '319861000119106', '319871000119100', '319941000119103',
                                      '319951000119101', '402426007', '129563009', '7607008', '59165007', '400054000',
                                      '241934007', '239948006', '858580008', '402457007', '234019004', '241941001',
                                      '1092461000119104', '14311001', '240130007', '238153009', '238156001',
                                      '276230003', '238154003', '735975001', '13886001', '68815009', '73286009',
                                      '4676006', '76521009', '36402006', '52042003', '11013005', '1231732006',
                                      '1197362009', '33719002', '89449005', '402719006', '56019007', '238980001',
                                      '238149007', '43641000119102', '238804007', '397016004', '397015000', '201796004',
                                      '1149219001', '89155008', '443872005', '128461001', '298285004', '128460000',
                                      '1187615007', '359789008', '68216000', '8435000', '52403007', '404908004',
                                      '1142107003', '64766004', '697969008', '235714007', '196987008', '444548001',
                                      '295046003', '86219005', '234020005', '241932006', '237877004')) AND
                                    (c.resource #>> '{onset,dateTime}')::timestamp < '2023-10-01'::timestamp AND
                                    (c.resource #> '{abatement,dateTime}' IS NULL OR (c.resource #>> '{abatement,dateTime}')::timestamp > '2023-10-01'::timestamp)) OR
                                   (coding ->> 'code' IN
                                    ('733137002', '733138007', '733139004', '14669001', '368951000119105', '722095005',
                                     '870589006', '722096006', '722278006', '1177174007', '88380005', '140031000119103',
                                     '438783006', '422593004', '429224003', '269257004', '423533009', '429489008',
                                     '36225005', '145681000119101', '1263955004', '1263956003', '129721000119106',
                                     '430535006', '236424009', '723189000', '298015003', '236433006', '236552002',
                                     '691421000119108', '707324008', '49708008', '310647000', '1801000119106',
                                     '789660001', '707742001', '700107006', '700109009', '700111000', '700112007',
                                     '717791000', '698591006', '445236007', '709044004', '722149000', '284961000119106',
                                     '104931000119100', '722150000', '722467000', '96441000119101', '771000119108',
                                     '722098007', '713313000', '431855005', '284971000119100', '368421000119108',
                                     '117681000119102', '90721000119101', '751000119104', '431856006',
                                     '284981000119102', '368431000119106', '129181000119109', '90731000119103',
                                     '741000119101', '433144002', '284991000119104', '368441000119102',
                                     '129171000119106', '90741000119107', '731000119105', '700378005', '700379002',
                                     '431857002', '285001000119105', '368451000119100', '129151000119102',
                                     '90751000119109', '721000119107', '433146000', '285011000119108',
                                     '368461000119103', '129161000119100', '90761000119106', '711000119100',
                                     '714152005', '714153000', '897308007', '57557005', '425369003', '90688005',
                                     '723190009', '444976001', '268854008', '23697004', '373421000', '373422007',
                                     '109477002', '712487000', '111411000119103', '368471000119109', '153891000119101',
                                     '90771000119100', '90791000119104', '236435004', '236434000', '236436003',
                                     '46177005', '17380002', '62216007', '722721004', '111407006', '36568005',
                                     '1269225005', '78209002', '716864001', '51292008', '213231008', '31005002',
                                     '22846003', '704667004', '128001000119105', '127991000119101', '71701000119105',
                                     '71421000119105', '140131000119102', '140121000119100', '140111000119107',
                                     '140101000119109', '8501000119104', '96701000119107', '96751000119106',
                                     '96741000119109', '96731000119100', '96721000119103', '96711000119105',
                                     '194781004', '194780003', '49220004', '776416004', '733097003', '1220586000',
                                     '609455009', '609472002', '609452007', '1269270002', '285831000119108',
                                     '285851000119102', '285861000119100', '285871000119106', '285881000119109',
                                     '153851000119106', '285841000119104', '286371000119107', '43258006', '708975004',
                                     '424114000', '724093004', '236428007', '197664009', '200118004', '301814009',
                                     '275408006', '1259460004', '733839001', '12245621000119102', '118781000119108',
                                     '10757401000119104', '10757481000119107', '129561000119108', '236432001',
                                     '236369004', '10752771000119100', '269301005', '363287001', '1220648003',
                                     '198647008', '737327002', '42399005', '713696000', '197671004', '236423003',
                                     '713453003', '723188008', '16726004', '1217070004', '897310009', '897312001',
                                     '897311008', '1263953006', '1263954000', '1208934006', '45646000', '307309005',
                                     '236431008')))
                              AND (c.resource #>> '{onset,dateTime}')::timestamp < '2023-10-01'::timestamp)
                           UNION
                           (SELECT o.resource #>> '{subject,id}'
                            FROM observation o,
                                 jsonb_array_elements(o.resource #> '{code,coding}') coding,
                                 jsonb_array_elements(o.resource #> '{value,Quantity}' || '[]') quantity
                            WHERE coding ->> 'system' = 'http://loinc.org'
                              AND quantity ->> 'system' = 'http://unitsofmeasure.org'
                              AND coding ->> 'code' = '39165-5'
                              AND quantity ->> 'code' = 'kg/m2'
                              AND (quantity ->> 'value')::decimal > 30.0
                              AND (o.resource #>> '{effective,dateTime}')::timestamp <@
                                  '[2022-10-01,2023-10-01)'::tsrange)
                           UNION
                           (SELECT ai.resource #>> '{patient,id}'
                            FROM allergyintolerance ai,
                                 jsonb_array_elements(ai.resource #> '{code,coding}') coding
                            WHERE coding ->> 'system' = 'http://www.nlm.nih.gov/research/umls/rxnorm'
                              AND coding ->> 'code' IN ('8782', '4337', '68139', '36453', '1815')
                              AND (ai.resource ->> 'recordedDate')::timestamp < '2023-10-01'::timestamp))