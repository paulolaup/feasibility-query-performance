SELECT COUNT(DISTINCT (inclusion.id))
FROM ((SELECT p.id
       FROM patient p
       WHERE (p.resource ->> 'birthDate')::timestamp < '2005-10-01'::timestamp
         AND (p.resource ->> 'gender' = 'male' OR p.id IN ((SELECT proc.resource #>> '{subject,id}'
                                                            FROM procedure proc,
                                                                 jsonb_array_elements(proc.resource #> '{code,coding}') coding
                                                            WHERE coding ->> 'system' = 'http://snomed.info/sct'
                                                              AND ((coding ->> 'code' IN ('287664005', '169553002') AND
                                                                    (proc.resource #>> '{performed,Period,end}')::timestamp >
                                                                    '[2019-10-01,2023-10-01)'::datetime) OR
                                                                   (coding ->> 'code' IN ('65200003', '46706006') AND
                                                                    (proc.resource #>> '{performed,Period,end}')::timestamp >
                                                                    '[2018-10-01,2023-10-01)'::tsrange)))
                                                           UNION
                                                           (SELECT ai.resource #>> '{subject,id}'
                                                            FROM medicationadministration ai,
                                                                 jsonb_array_elements(ai.resource #> '{medication,CodeableConcept,coding}') coding
                                                            WHERE coding ->> 'system' = 'http://www.nlm.nih.gov/research/umls/rxnorm'
                                                              AND coding ->> 'code' IN ('1359133', '748962' , '831533')
                                                              AND (ai.resource #>> '{effective,dateTime}')::timestamp <@
                                                                  '[2023-09-01,2023-10-01)'::tsrange))))
      INTERSECT
      (SELECT c.resource #>> '{subject,id}'
       FROM condition c,
            jsonb_array_elements(c.resource #> '{code,coding}') coding
       WHERE coding ->> 'system' = 'http://snomed.info/sct'
         AND (coding ->> 'code' IN ('425178004', '301756000', '312111009', '269533000', '312113007', '312114001', '269544008', '285312008', '312115000', '312112002', '1197359006', '315058005', '1156795003', '1156788007', '314965007', '133751000119102', '449218003', '726654006', '123691000119104', '187760008', '363412000', '363406005', '363409003', '363407001', '363414004', '363410008', '363413005', '363408006', '1237460003', '1237484006', '1237455002', '1237456001', '1237485007', '1237480002', '1237454003', '1237458000', '94179005', '94260004', '94271003', '94328005', '94509004', '94538001', '94604000', '94643001', '737058005', '109838007', '96281000119107', '681601000119101', '721695008', '1701000119104', '681651000119102', '721699002', '184881000119106', '721696009', '1259403004', '1259436003', '1259405006', '1259406007', '1259437007', '1259432001', '1259407003', '1259404005', '16636051000119105', '1197354001', '93683002', '93761005', '93771007', '93826009', '1163568002', '93980002', '94006002', '94072004', '94105000', '721698005', '721697000', '1268635000', '766981007'))
         AND (c.resource #>> '{onset,dateTime}')::timestamp < '2023-10-01'::timestamp)
      INTERSECT
      (SELECT p.resource #>> '{subject,id}'
       FROM procedure p,
            jsonb_array_elements(p.resource #> '{code,coding}') coding
       WHERE coding ->> 'system' = 'http://snomed.info/sct'
         AND (coding ->> 'code' IN ('367336001', '703423002'))
         AND (p.resource #>> '{performed,Period,end}')::timestamp <@ '[2023-08-01,2023-10-01)'::tsrange)
      INTERSECT
      (SELECT o.resource #>> '{subject,id}'
       FROM observation o,
            jsonb_array_elements(o.resource #> '{code,coding}') coding,
       WHERE coding ->> 'system' = 'http://loinc.org'
         AND coding ->> 'code' = '751-8'
         AND o.resource #>> '{value,Quantity,system}' = 'http://unitsofmeasure.org'
         AND o.resource #>> '{value,Quantity,code}' = '10*3/uL'
         AND (o.resource #>> '{value,Quantity,value}')::decimal > 4.0
         AND (o.resource #>> '{effective,dateTime}')::timestamp <@ '[2023-09-01, 2023-10-01)'::tsrange)) inclusion
WHERE inclusion.id NOT IN ((SELECT c.resource #>> '{subject,id}'
                            FROM condition c,
                                 jsonb_array_elements(c.resource #> '{code,coding}') coding
                            WHERE coding ->> 'system' = 'http://snomed.info/sct'
                                AND (((coding ->> 'code' IN ('699240001', '169470007', '31601007', '442478007', '12275071000119109', '199306007', '237247003', '199307003', '472321009', '429187001', '36801000119105', '102955006', '169533001', '21987001', '275429002', '237321009', '199863008', '169524003', '72957006', '459166009', '713575004', '89244003', '9279009', '45307008', '169550004', '127373004', '127365008', '127366009', '127367000', '127368005', '127369002', '127370001', '127371002', '127372009', '127374005', '47200007', '444661007', '134781000119106', '1148970006', '439311009', '69777007', '65727000', '169488004', '73621009', '459168005', '459170001', '459169002', '459171002', '459167000', '713576003', '2256007', '102876002', '443460007', '80224003', '16356006', '1148848009', '199378009', '199381004', '428511009', '72892002', '1268535008', '169545005', '169544009', '14418008', '77386006', '568141000005106', '102872000', '813541000000100', '169567006', '169566002', '890096007', '169561007', '169564004', '169563005', '169560008', '169562000', '169501005', '169508004', '82634006', '80856001', '17618008', '6867004', '169471006', '60810003', '199326006', '35381000119101', '80997009', '38720006', '43990006', '102875003', '169539002', '64254006', '199322008', '65147003', '199318003', '417006004', '237236005', '237237001', '83074005', '169568001', '58532003', '237245006', '169548007') AND
                                      (c.resource #>> '{onset,dateTime}')::timestamp < '2023-10-01'::timestamp))
                               OR ((coding ->> 'code' IN ('123717006', '420054005', '197303009', '1761006', '197310003', '197296006', '74669004', '266470007', '123606000', '266468003', '19943007', '725939009', '725938001', '725940006', '871619002', '831000119103', '103611000119102', '735733008', '271440004', '725416005', '37688005', '45256007', '89580002', '716203000', '197293003', '425413006', '371139006', '197294009', '76301009', '536002', '235897005', '715864007', '6183001', '235896001', '266471006', '235895002', '123716002', '1010616001', '43904005', '21861000', '15999000', '266469006', '699189004', '123605001', '109819003', '33144001', '78208005', '197299004', '419728003', '27156006', '86454000', '31712002', '715401008', '12368000', '16070004', '197305002', '123604002', '197301006', '197291001'))
                                AND (c.resource #>> '{onset,dateTime}')::timestamp < '2023-10-01'::timestamp)))
