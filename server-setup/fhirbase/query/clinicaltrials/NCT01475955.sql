SELECT COUNT(DISTINCT(inclusion.id))
FROM ((SELECT p.id FROM patient p)) AS inclusion
WHERE inclusion.id NOT IN ((SELECT c.resource #>> '{subject,id}'
                            FROM condition c,
                                 jsonb_array_elements(c.resource #> '{code,coding}') coding
                            WHERE coding ->> 'system' = 'http://snomed.info/sct'
                                AND ((coding ->> 'code' IN
                                      ('699240001', '169470007', '31601007', '442478007', '12275071000119109',
                                       '199306007', '237247003', '199307003', '472321009', '429187001',
                                       '36801000119105', '102955006', '169533001', '21987001', '275429002', '237321009',
                                       '199863008', '169524003', '72957006', '459166009', '713575004', '89244003',
                                       '9279009', '45307008', '169550004', '127373004', '127365008', '127366009',
                                       '127367000', '127368005', '127369002', '127370001', '127371002', '127372009',
                                       '127374005', '47200007', '444661007', '134781000119106', '1148970006',
                                       '439311009', '69777007', '65727000', '169488004', '73621009', '459168005',
                                       '459170001', '459169002', '459171002', '459167000', '713576003', '2256007',
                                       '102876002', '443460007', '80224003', '16356006', '1148848009', '199378009',
                                       '199381004', '428511009', '72892002', '1268535008', '169545005', '169544009',
                                       '14418008', '77386006', '568141000005106', '102872000', '813541000000100',
                                       '169567006', '169566002', '890096007', '169561007', '169564004', '169563005',
                                       '169560008', '169562000', '169501005', '169508004', '82634006', '80856001',
                                       '17618008', '6867004', '169471006', '60810003', '199326006', '35381000119101',
                                       '80997009', '38720006', '43990006', '102875003', '169539002', '64254006',
                                       '199322008', '65147003', '199318003', '417006004', '237236005', '237237001',
                                       '83074005', '169568001', '58532003', '237245006', '169548007')
                                    OR coding ->> 'code' IN
                                       ('254654004', '254732008', '254711000', '721762007', '276751004', '404135007',
                                        '254794007', '403949007', '403742006', '402524007', '402525008', '402544001',
                                        '402526009', '402527000', '402528005', '402529002', '402547008', '402536001',
                                        '402545000', '402546004', '402516002', '402500004', '402515003', '400174005',
                                        '402512000', '424666005', '423463003', '402507001', '423535002', '402508006',
                                        '402511007', '402498000', '402820007', '399954008', '423325007', '231832009',
                                        '402519009', '403916003', '403918002', '402520003', '402510008', '402496001',
                                        '402499008', '402518001', '402522006', '402494003', '402506005', '402495002',
                                        '61471000119100', '402503002', '402504008', '402509003', '402818009',
                                        '402514004', '400057007', '399897004', '399934007', '402497005', '403915004',
                                        '254701007', '402819001', '402501000', '403917007', '402502007', '402513005',
                                        '402523001', '402517006', '402521004', '403919005', '402505009', '717731002',
                                        '402542002', '402541009', '402539008', '402540005', '402543007', '254710004',
                                        '402531006', '402530007', '402532004', '402533009', '402534003', '254702000',
                                        '15951021000119107', '15951061000119102', '404115006', '255068000',
                                        '1145245004', '449416001', '286891000', '372125008', '372127000', '372129002',
                                        '423349005', '404087009', '404129007', '404128004', '404130002', '404131003',
                                        '404126000', '404127009', '403951006', '403910009', '765328000', '403940006',
                                        '254652000', '254748009', '403912001', '449217008', '254709009', '400173004',
                                        '403939009', '254708001', '254800003', '404045007', '404114005', '254727007',
                                        '726019003', '254703005', '254820002', '404109006', '448865007', '404121005',
                                        '404016005', '69408002', '404155008', '404112009', '402882001', '403274000',
                                        '404110001', '403996004', '404017001', '423829008', '109386008',
                                        '10976631000119101', '302837001', '404156009', '404122003', '404124002',
                                        '404123008', '404152006', '404153001', '404139001', '404154007', '404151004',
                                        '314976006', '314975005', '404120006', '403458008', '404106004', '404111002',
                                        '429114002', '307603002', '403943008', '403941005', '403942003', '254650008',
                                        '402873007', '404014008', '254797000', '404091004', '254734009', '254733003',
                                        '1197294001', '188033007', '403927001', '93209006', '93655004', '93210001',
                                        '93211002', '447712006', '93213004', '93214005', '93215006', '93216007',
                                        '423280002', '93217003', '93218008', '93219000', '93220006', '93221005',
                                        '93222003', '93223008', '93224002', '93225001', '93226000', '93227009',
                                        '93228004', '93229007', '93230002', '93636004', '93637008', '93638003',
                                        '400375351000119102', '808558991000119105', '1081021000119109',
                                        '352201000119105', '985355341000119101', '93640008', '423447006', '449636007',
                                        '93641007', '424302003', '93642000', '93643005', '448298007', '93644004',
                                        '93645003', '243971001000119103', '939595491000119108', '352001000119100',
                                        '351961000119109', '249389151000119103', '93646002', '448273006', '93647006',
                                        '93648001', '93649009', '93650009', '93651008', '93652001', '449637003',
                                        '423494003', '93653006', '424487008', '448300007', '93654000', '271467005',
                                        '402636006', '188103003', '188102008', '372130007', '372122006', '188110009',
                                        '188090007', '188107002', '188095002', '188089003', '188091006', '423425006',
                                        '443136000', '188122007', '188138001', '188135003', '188133005', '372124007',
                                        '188099008', '188132000', '311779007', '449309003', '188100000', '188125009',
                                        '372126009', '188121000', '372128005', '254726003', '254707006', '255096006',
                                        '255093003', '254908006', '276750003', '402652009', '717968005', '253001006',
                                        '133841000119105', '352071000119105', '133881000119100', '351461000119100',
                                        '133871000119103', '1254750009', '1237621006', '91231000119104', '1264257008',
                                        '402537005', '1254755004', '1236953005', '1237424008', '1240372009',
                                        '404092006', '1237477003', '1237519007', '1237478008', '1237520001',
                                        '1237521002', '1264364008', '1254748001', '1268355005', '1197324006',
                                        '402563000', '94159002', '94483003', '94532000', '94579000', '94539009',
                                        '94540006', '94542003', '94543008', '94544002', '94545001', '94546000',
                                        '94547009', '94548004', '94549007', '94550007', '94551006', '94552004',
                                        '94553009', '94554003', '94555002', '94556001', '94557005', '94558000',
                                        '94559008', '94560003', '188454009', '94561004', '827186009', '94562006',
                                        '94564007', '449630001', '94565008', '94566009', '94567000', '94568005',
                                        '94569002', '94570001', '94571002', '188458007', '94572009', '94573004',
                                        '94574005', '94575006', '94576007', '449631002', '94577003', '94578008',
                                        '94617002', '1263651005', '1263997005', '1254753006', '1264369003',
                                        '78461000119105', '254712007', '403954003', '403950007', '403913006',
                                        '254714008', '254713002', '118618005', '16775311000119107', '686981000119108',
                                        '94707004', '94708009', '94709001', '686991000119106', '1255752007',
                                        '1255754008', '188627002', '1255753002', '1255886009', '94714002', '404116007',
                                        '400175006', '404046008', '716274007', '254731001', '403911008', '448447004',
                                        '722712000', '109267002', '109264009', '236811000119101', '403946000',
                                        '447738006', '254898001', '404119000', '404107008', '402911002', '403947009',
                                        '254764001', '403909004', '307610008', '254655003', '398903003', '404108003',
                                        '1259374007', '1259380004', '79281000119106', '1259594004', '721540005',
                                        '1259319007', '16091131000119108', '16091411000119109', '16091251000119109',
                                        '16091371000119108', '1259573002', '1259544000', '1259546003', '1259548002',
                                        '1079101000119105', '1079111000119108', '16905501000119104', '1079131000119103',
                                        '16905381000119100', '1079091000119100', '1079161000119106', '1079171000119100',
                                        '16905461000119104', '1079191000119104', '16905421000119109',
                                        '1079151000119109', '16774671000119108', '15950141000119105',
                                        '428487561000119102', '16774551000119100', '1079121000119101',
                                        '1079141000119107', '690141000119103', '682541000119106', '15950101000119108',
                                        '145194251000119106', '16774591000119105', '1079181000119102',
                                        '1079201000119101', '690121000119109', '1259377000', '1259376009', '1259680005',
                                        '1259530006', '1259532003', '1259533008', '1259587002', '1259575009',
                                        '1259569000', '1259372006', '773995001', '402881008', '128875000', '765136002',
                                        '404144008', '735332000', '1259381000', '404143002', '733627006', '404141000',
                                        '402880009', '400001003', '404140004', '404142007', '400122007', '1259593005',
                                        '1259599009', '1259567003', '1259592000', '1259382007', '1268956001',
                                        '1259793007', '1259781003', '1259580000', '1259782005', '1259791009',
                                        '1186616001', '1259424009', '1259736002', '1259778008', '1259777003',
                                        '1259779000', '1268881002', '93663003', '93956001', '94000008', '94047004',
                                        '724866001', '372123001', '94007006', '688381000119106', '94008001', '94010004',
                                        '94011000', '94012007', '688321000119107', '94013002', '94014008', '94015009',
                                        '94016005', '94017001', '94018006', '94019003', '94020009', '94021008',
                                        '94022001', '94023006', '94024000', '94025004', '94026003', '94027007',
                                        '94028002', '94029005', '94030000', '15950221000119108', '352391000119109',
                                        '16905541000119102', '352481000119103', '352421000119102', '16905581000119107',
                                        '352381000119106', '94032008', '449634005', '94033003', '94034009', '94035005',
                                        '94036006', '94037002', '15950061000119105', '352431000119104',
                                        '16905341000119105', '352461000119107', '352471000119101', '16905141000119107',
                                        '355141000119106', '94038007', '94039004', '94040002', '94041003',
                                        '688411000119109', '94042005', '94043000', '94044006', '94045007', '94046008',
                                        '94081005', '721541009', '1259596002', '1259577001', '1259612006', '1259557008',
                                        '1259260002', '1259251005', '1259601006', '1259459009', '1259379002',
                                        '1259796004', '1268908007', '1259797008', '1259795000', '1259790005',
                                        '1268699008', '1259375008', '1259789001', '1259416004', '1259618005',
                                        '276738009', '1259571000', '1259373001', '689211000119102', '16899941000119102',
                                        '16899901000119104', '455733521000119103', '15949941000119101',
                                        '16782241000119104', '1082091000119101', '1082101000119106', '1082131000119104',
                                        '1082051000119106', '16218761000119102', '15950021000119100',
                                        '16782321000119104', '1082211000119104', '1082221000119106', '1082261000119101',
                                        '1082171000119101', '1259559006', '1259780002', '1259378005', '1259566007',
                                        '1259578006', '254792006', '403712008', '403714009', '403711001', '403713003',
                                        '403729006', '402538000', '404093001', '307599002', '231833004', '118611004',
                                        '188633006', '403944002', '404138009', '404157000', '254653005', '404117003',
                                        '422676009', '423700001', '422599000', '422378004', '422572002', '423506005',
                                        '231831002', '403895004', '403893006', '403896003', '402817004', '424260006',
                                        '403468003', '403891008', '276860003', '254651007', '285309005', '403894000',
                                        '403892001', '403898002', '285308002', '423284006', '403899005', '285307007',
                                        '425148008', '423896007', '403897007', '62497000', '404133000', '403914000',
                                        '404015009', '254730000', '404118008', '1255799000', '1255801002', '1255800001',
                                        '188632001', '188635004', '188631008', '188634000', '188637007', '95263006',
                                        '402879006', '403929003', '404113004', '403955002', '402912009')
                                    OR coding ->> 'code' IN ('315276005')
                                    OR coding ->> 'code' IN
                                       ('254654004', '254732008', '254711000', '721762007', '276751004', '404135007',
                                        '254794007', '403949007', '403742006', '402524007', '402525008', '402544001',
                                        '402526009', '402527000', '402528005', '402529002', '402547008', '402536001',
                                        '402545000', '402546004', '402516002', '402500004', '402515003', '400174005',
                                        '402512000', '424666005', '423463003', '402507001', '423535002', '402508006',
                                        '402511007', '402498000', '402820007', '399954008', '423325007', '231832009',
                                        '402519009', '403916003', '403918002', '402520003', '402510008', '402496001',
                                        '402499008', '402518001', '402522006', '402494003', '402506005', '402495002',
                                        '61471000119100', '402503002', '402504008', '402509003', '402818009',
                                        '402514004', '400057007', '399897004', '399934007', '402497005', '403915004',
                                        '254701007', '402819001', '402501000', '403917007', '402502007', '402513005',
                                        '402523001', '402517006', '402521004', '403919005', '402505009', '717731002',
                                        '402542002', '402541009', '402539008', '402540005', '402543007', '254710004',
                                        '402531006', '402530007', '402532004', '402533009', '402534003', '254702000',
                                        '15951021000119107', '15951061000119102', '404115006', '255068000',
                                        '1145245004', '449416001', '286891000', '372125008', '372127000', '372129002',
                                        '423349005', '404087009', '404129007', '404128004', '404130002', '404131003',
                                        '404126000', '404127009', '403951006', '403910009', '765328000', '403940006',
                                        '254652000', '254748009', '403912001', '449217008', '254709009', '400173004',
                                        '403939009', '254708001', '254800003', '404045007', '404114005', '254727007',
                                        '726019003', '254703005', '254820002', '404109006', '448865007', '404121005',
                                        '404016005', '69408002', '404155008', '404112009', '402882001', '403274000',
                                        '404110001', '403996004', '404017001', '423829008', '109386008',
                                        '10976631000119101', '302837001', '404156009', '404122003', '404124002',
                                        '404123008', '404152006', '404153001', '404139001', '404154007', '404151004',
                                        '314976006', '314975005', '404120006', '403458008', '404106004', '404111002',
                                        '429114002', '307603002', '403943008', '403941005', '403942003', '254650008',
                                        '402873007', '404014008', '254797000', '404091004', '254734009', '254733003',
                                        '1197294001', '188033007', '403927001', '93209006', '93655004', '93210001',
                                        '93211002', '447712006', '93213004', '93214005', '93215006', '93216007',
                                        '423280002', '93217003', '93218008', '93219000', '93220006', '93221005',
                                        '93222003', '93223008', '93224002', '93225001', '93226000', '93227009',
                                        '93228004', '93229007', '93230002', '93636004', '93637008', '93638003',
                                        '400375351000119102', '808558991000119105', '1081021000119109',
                                        '352201000119105', '985355341000119101', '93640008', '423447006', '449636007',
                                        '93641007', '424302003', '93642000', '93643005', '448298007', '93644004',
                                        '93645003', '243971001000119103', '939595491000119108', '352001000119100',
                                        '351961000119109', '249389151000119103', '93646002', '448273006', '93647006',
                                        '93648001', '93649009', '93650009', '93651008', '93652001', '449637003',
                                        '423494003', '93653006', '424487008', '448300007', '93654000', '271467005',
                                        '402636006', '188103003', '188102008', '372130007', '372122006', '188110009',
                                        '188090007', '188107002', '188095002', '188089003', '188091006', '423425006',
                                        '443136000', '188122007', '188138001', '188135003', '188133005', '372124007',
                                        '188099008', '188132000', '311779007', '449309003', '188100000', '188125009',
                                        '372126009', '188121000', '372128005', '254726003', '254707006', '255096006',
                                        '255093003', '254908006', '276750003', '402652009', '717968005', '253001006',
                                        '133841000119105', '352071000119105', '133881000119100', '351461000119100',
                                        '133871000119103', '1254750009', '1237621006', '91231000119104', '1264257008',
                                        '402537005', '1254755004', '1236953005', '1237424008', '1240372009',
                                        '404092006', '1237477003', '1237519007', '1237478008', '1237520001',
                                        '1237521002', '1264364008', '1254748001', '1268355005', '1197324006',
                                        '402563000', '94159002', '94483003', '94532000', '94579000', '94539009',
                                        '94540006', '94542003', '94543008', '94544002', '94545001', '94546000',
                                        '94547009', '94548004', '94549007', '94550007', '94551006', '94552004',
                                        '94553009', '94554003', '94555002', '94556001', '94557005', '94558000',
                                        '94559008', '94560003', '188454009', '94561004', '827186009', '94562006',
                                        '94564007', '449630001', '94565008', '94566009', '94567000', '94568005',
                                        '94569002', '94570001', '94571002', '188458007', '94572009', '94573004',
                                        '94574005', '94575006', '94576007', '449631002', '94577003', '94578008',
                                        '94617002', '1263651005', '1263997005', '1254753006', '1264369003',
                                        '78461000119105', '254712007', '403954003', '403950007', '403913006',
                                        '254714008', '254713002', '118618005', '16775311000119107', '686981000119108',
                                        '94707004', '94708009', '94709001', '686991000119106', '1255752007',
                                        '1255754008', '188627002', '1255753002', '1255886009', '94714002', '404116007',
                                        '400175006', '404046008', '716274007', '254731001', '403911008', '448447004',
                                        '722712000', '109267002', '109264009', '236811000119101', '403946000',
                                        '447738006', '254898001', '404119000', '404107008', '402911002', '403947009',
                                        '254764001', '403909004', '307610008', '254655003', '398903003', '404108003',
                                        '1259374007', '1259380004', '79281000119106', '1259594004', '721540005',
                                        '1259319007', '16091131000119108', '16091411000119109', '16091251000119109',
                                        '16091371000119108', '1259573002', '1259544000', '1259546003', '1259548002',
                                        '1079101000119105', '1079111000119108', '16905501000119104', '1079131000119103',
                                        '16905381000119100', '1079091000119100', '1079161000119106', '1079171000119100',
                                        '16905461000119104', '1079191000119104', '16905421000119109',
                                        '1079151000119109', '16774671000119108', '15950141000119105',
                                        '428487561000119102', '16774551000119100', '1079121000119101',
                                        '1079141000119107', '690141000119103', '682541000119106', '15950101000119108',
                                        '145194251000119106', '16774591000119105', '1079181000119102',
                                        '1079201000119101', '690121000119109', '1259377000', '1259376009', '1259680005',
                                        '1259530006', '1259532003', '1259533008', '1259587002', '1259575009',
                                        '1259569000', '1259372006', '773995001', '402881008', '128875000', '765136002',
                                        '404144008', '735332000', '1259381000', '404143002', '733627006', '404141000',
                                        '402880009', '400001003', '404140004', '404142007', '400122007', '1259593005',
                                        '1259599009', '1259567003', '1259592000', '1259382007', '1268956001',
                                        '1259793007', '1259781003', '1259580000', '1259782005', '1259791009',
                                        '1186616001', '1259424009', '1259736002', '1259778008', '1259777003',
                                        '1259779000', '1268881002', '93663003', '93956001', '94000008', '94047004',
                                        '724866001', '372123001', '94007006', '688381000119106', '94008001', '94010004',
                                        '94011000', '94012007', '688321000119107', '94013002', '94014008', '94015009',
                                        '94016005', '94017001', '94018006', '94019003', '94020009', '94021008',
                                        '94022001', '94023006', '94024000', '94025004', '94026003', '94027007',
                                        '94028002', '94029005', '94030000', '15950221000119108', '352391000119109',
                                        '16905541000119102', '352481000119103', '352421000119102', '16905581000119107',
                                        '352381000119106', '94032008', '449634005', '94033003', '94034009', '94035005',
                                        '94036006', '94037002', '15950061000119105', '352431000119104',
                                        '16905341000119105', '352461000119107', '352471000119101', '16905141000119107',
                                        '355141000119106', '94038007', '94039004', '94040002', '94041003',
                                        '688411000119109', '94042005', '94043000', '94044006', '94045007', '94046008',
                                        '94081005', '721541009', '1259596002', '1259577001', '1259612006', '1259557008',
                                        '1259260002', '1259251005', '1259601006', '1259459009', '1259379002',
                                        '1259796004', '1268908007', '1259797008', '1259795000', '1259790005',
                                        '1268699008', '1259375008', '1259789001', '1259416004', '1259618005',
                                        '276738009', '1259571000', '1259373001', '689211000119102', '16899941000119102',
                                        '16899901000119104', '455733521000119103', '15949941000119101',
                                        '16782241000119104', '1082091000119101', '1082101000119106', '1082131000119104',
                                        '1082051000119106', '16218761000119102', '15950021000119100',
                                        '16782321000119104', '1082211000119104', '1082221000119106', '1082261000119101',
                                        '1082171000119101', '1259559006', '1259780002', '1259378005', '1259566007',
                                        '1259578006', '254792006', '403712008', '403714009', '403711001', '403713003',
                                        '403729006', '402538000', '404093001', '307599002', '231833004', '118611004',
                                        '188633006', '403944002', '404138009', '404157000', '254653005', '404117003',
                                        '422676009', '423700001', '422599000', '422378004', '422572002', '423506005',
                                        '231831002', '403895004', '403893006', '403896003', '402817004', '424260006',
                                        '403468003', '403891008', '276860003', '254651007', '285309005', '403894000',
                                        '403892001', '403898002', '285308002', '423284006', '403899005', '285307007',
                                        '425148008', '423896007', '403897007', '62497000', '404133000', '403914000',
                                        '404015009', '254730000', '404118008', '1255799000', '1255801002', '1255800001',
                                        '188632001', '188635004', '188631008', '188634000', '188637007', '95263006',
                                        '402879006', '403929003', '404113004', '403955002', '402912009'))
                                    AND (c.resource #>> '{onset,dateTime}')::timestamp < '2023-10-01'::timestamp
                                    AND (c.resource #>> '{abatement,dateTime}' IS null OR
                                         (c.resource #>> '{abatement,dateTime}')::timestamp > '2023-10-01'::timestamp))
                               OR (coding ->> 'code' IN
                                   ('1155910005', '234422006', '84816006', '22935002', '190913009', '190915002',
                                    '123965000', '43599001', '61164006', '67312003', '51022005', '860859009',
                                    '1186810009', '783615009', '59229005', '55056006', '7425008', '238054000',
                                    '238053006', '238056003', '111386004', '238057007', '64081000', '418470004',
                                    '61860000', '403738008', '403737003', '111387008', '47632004', '402479002',
                                    '123964001', '58275005', '1197360001') AND
                                   (c.resource #>> '{onset,dateTime}')::timestamp < '2023-10-01'::timestamp))
                           UNION
                           (SELECT aggregation.subject_id
                            FROM (SELECT c.resource #>> '{subject,id}' AS subject_id, count(*) AS cnt
                                  FROM condition c,
                                       jsonb_array_elements(c.resource #> '{code,coding}') coding
                                  WHERE coding ->> 'system' = 'http://snomed.info/sct'
                                    AND coding ->> 'code' IN
                                        ('1155910005', '234422006', '84816006', '22935002', '190913009', '190915002',
                                         '123965000', '43599001', '61164006', '67312003', '51022005', '860859009',
                                         '1186810009', '783615009', '59229005', '55056006', '7425008', '238054000',
                                         '238053006', '238056003', '111386004', '238057007', '64081000', '418470004',
                                         '61860000', '403738008', '403737003', '111387008', '47632004', '402479002',
                                         '123964001', '58275005', '1197360001')
                                    AND (c.resource #>> '{onset,dateTime}')::timestamp <@ '[2022-10-01, 2023-10-01)'::tsrange
                                  GROUP BY subject_id) AS aggregation
                            WHERE aggregation.cnt >= 2)
                           UNION
                           (SELECT ai.resource #>> '{patient,id}'
                            FROM allergyintolerance ai,
                                 jsonb_array_elements(ai.resource #> '{code,coding}') coding
                            WHERE coding ->> 'system' = 'http://www.nlm.nih.gov/research/umls/rxnorm'
                              AND coding ->> 'code' IN ('8516', '448', '797541', '393540')
                              AND (ai.resource #>> '{recordedDate}')::timestamp < '2023-10-01'::timestamp))